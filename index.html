<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - HTF Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .main-card { max-width: 1000px; margin: 30px auto; border: none; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-header { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 12px 12px 0 0 !important; padding: 15px 20px; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #555; }
        .btn-submit { padding: 12px 50px; font-weight: bold; text-transform: uppercase; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }

        /* LIGHTBOX */
        #lightbox-gallery { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #lightbox-img { max-width: 90%; max-height: 80vh; border: 2px solid white; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        #lightbox-caption { color: white; margin-top: 10px; font-size: 1.2rem; font-weight: bold; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); color: white; border: none; padding: 15px; cursor: pointer; font-size: 2rem; border-radius: 50%; transition: 0.3s; }
        .lightbox-nav:hover { background: rgba(255,255,255,0.3); } .lb-prev { left: 20px; } .lb-next { right: 20px; } .lb-close { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; color: white; cursor: pointer; }
        .img-preview { width: 100%; height: 120px; object-fit: cover; border: 1px dashed #ccc; border-radius: 6px; margin-top: 5px; display: none; background-color: #fff; cursor: zoom-in; }

        /* TABLE & STATS */
        .table-history th { background-color: #f1f3f5; font-size: 0.85rem; text-transform: uppercase; text-align: center; vertical-align: middle; }
        .table-history td { vertical-align: middle; font-size: 0.9rem; text-align: center; }
        .sortable-header { cursor: pointer; user-select: none; } .sortable-header:hover { background-color: #e9ecef; }
        .status-badge { padding: 4px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; }
        .bg-win { background-color: #d1e7dd; color: #0f5132; } .bg-loss { background-color: #f8d7da; color: #842029; } .bg-be { background-color: #e2e3e5; color: #41464b; }
        .detail-img-box { width: 100%; height: 150px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative; cursor: zoom-in; transition: transform 0.2s; } .detail-img-box:hover { transform: scale(1.03); border-color: #0d6efd; } .detail-img-box img { width: 100%; height: 100%; object-fit: cover; } .detail-img-box span { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; text-align: center; font-size: 0.8rem; padding: 3px; }
        .progress { height: 6px; margin-top: 5px; } .stat-winrate { font-weight: bold; font-size: 0.95rem; }
        
        .stat-clickable { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 3px; transition: 0.2s; }
        .stat-clickable:hover { background-color: #e9ecef; color: #0d6efd; font-weight: bold; }
        .btn-back-stats { display: none; font-size: 0.9rem; font-weight: bold; color: white; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.1); margin-right: 10px; }
        .btn-back-stats:hover { background: rgba(255,255,255,0.3); color: white; }

        /* DASHBOARD TỔNG QUAN (CÓ HIỆU ỨNG CLICK) */
        .summary-box { text-align: center; padding: 10px; border-radius: 8px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, filter 0.2s; }
        .summary-box:hover { transform: translateY(-3px); filter: brightness(1.1); }
        .summary-box:active { transform: translateY(0); }
        
        .summary-box h3 { margin: 0; font-size: 1.5rem; font-weight: bold; }
        .summary-box span { font-size: 0.85rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .sb-total { background: linear-gradient(135deg, #6c757d, #495057); }
        .sb-win { background: linear-gradient(135deg, #198754, #146c43); }
        .sb-loss { background: linear-gradient(135deg, #dc3545, #b02a37); }
        .sb-be { background: linear-gradient(135deg, #ffc107, #d39e00); color: #333 !important; }
        .sb-rate { background: linear-gradient(135deg, #0d6efd, #0b5ed7); cursor: default; } /* Winrate ko bấm dc */
        .sb-rate:hover { transform: none; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div><h5 class="text-primary fw-bold">Đang xử lý dữ liệu...</h5></div>
    <div id="lightbox-gallery"><div class="lb-close" onclick="closeLightbox()">&times;</div><button class="lightbox-nav lb-prev" onclick="changeImage(-1)">&#10094;</button><img id="lightbox-img" src="" alt="Full Image"><div id="lightbox-caption">Caption</div><button class="lightbox-nav lb-next" onclick="changeImage(1)">&#10095;</button></div>

    <div class="container pb-5">
        <div class="card main-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="m-0"><i class="fas fa-chart-line me-2"></i>NHẬP LỆNH (HTF)</h5>
                <div>
                    <small id="status-connect" class="badge bg-warning text-dark me-2"><i class="fas fa-sync fa-spin me-1"></i> Connecting...</small>
                    <button class="btn btn-sm btn-light text-primary fw-bold me-1" onclick="openStatsModal()"><i class="fas fa-chart-pie me-1"></i> Thống kê</button>
                    <button class="btn btn-sm btn-light text-primary fw-bold" onclick="openHistoryModal()"><i class="fas fa-history me-1"></i> Lịch sử</button>
                </div>
            </div>

            <div class="card-body p-4">
                <form id="webForm" onsubmit="submitToSheet(event)">
                    <div class="row g-3 mb-3">
                        <div class="col-md-3"><label class="form-label">Thời gian</label><input type="datetime-local" class="form-control" name="thoigian" id="thoigian" required></div>
                        <div class="col-md-3"><label class="form-label">Cặp Tiền (Dòng tiền)</label><select class="form-select" name="trade" id="tradeSelect" required><option value="">Loading...</option></select></div>
                        <div class="col-md-3"><label class="form-label">Phiên</label><select class="form-select" name="phien"><option value="Phiên Á">Phiên Á</option><option value="Phiên Âu">Phiên Âu</option><option value="Phiên Mỹ">Phiên Mỹ</option><option value="Giao thoa">Giao thoa</option></select></div>
                        <div class="col-md-3"><label class="form-label">Setup (Entry)</label><div id="entry-container"><div class="input-group mb-2 entry-row"><input type="text" class="form-control entry-input" list="entryList" placeholder="Nhập setup..."><button class="btn btn-outline-success" type="button" onclick="addEntryField()"><i class="fas fa-plus"></i></button></div></div><datalist id="entryList"></datalist></div>
                    </div>
                    <hr class="text-muted opacity-25">
                    <h6 class="text-primary mb-3"><i class="fas fa-images me-2"></i>Hình ảnh phân tích</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="d1" placeholder="Link ảnh D1..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="h4" placeholder="Link ảnh H4..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="h1" placeholder="Link ảnh H1..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="m15" placeholder="Link ảnh M15..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label">Cảm nhận & Góc nhìn</label><textarea class="form-control mb-2" name="cam_nhan" rows="2"></textarea><textarea class="form-control" name="CainhinHTFvsLTF" rows="2"></textarea></div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-md-6"><label class="form-label">Kết quả (Auto)</label><select class="form-select" name="ketqua" id="ketquaSelect"><option value="">-- Auto --</option></select></div>
                                <div class="col-md-6"><label class="form-label">Số Pip (Auto KQ)</label><input type="number" step="0.1" class="form-control" name="pip" id="pipInput" oninput="autoCalculateResult(this)"></div>
                                <div class="col-md-12"><label class="form-label">Gồng lệnh</label><input type="text" class="form-control" name="gong_lenh"></div>
                            </div>
                        </div>
                    </div>
                     <div class="mb-4"><label class="form-label">Ảnh Thực tế & Ghi chú</label><div class="row g-2"><div class="col-md-6"><input type="url" class="form-control" name="thucte" placeholder="Link ảnh thực tế..." oninput="preview(this)"><img class="img-preview" style="height: 80px;" onclick="openSingleImage(this)"></div><div class="col-md-6"><textarea class="form-control" name="ghi_chu" rows="1" placeholder="Ghi chú thêm..."></textarea></div></div></div>
                    <div class="text-center"><button type="submit" class="btn btn-primary btn-submit shadow"><i class="fas fa-paper-plane me-2"></i> LƯU NHẬT KÝ</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historyModalTitle">Lịch Sử Giao Dịch</h5>
                    <div class="ms-auto"><button class="btn btn-sm btn-back-stats" id="btnBackToStats" onclick="backToStats()"><i class="fas fa-arrow-left me-1"></i> Quay lại TK</button><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                </div>
                <div class="modal-body p-0"><div class="table-responsive"><table class="table table-hover table-history mb-0"><thead class="table-light sticky-top"><tr><th>STT</th><th>Thời gian</th><th>Cặp tiền</th><th>Kết quả</th><th class="sortable-header" onclick="sortHistoryByPip()">Pip <i id="sortIcon" class="fas fa-sort sort-icon"></i></th><th>Chi tiết</th></tr></thead><tbody id="historyTableBody"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title" id="detailTitle">Chi tiết</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="detailBody"></div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-target="#historyModal" data-bs-toggle="modal">Quay lại</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="fas fa-chart-pie me-2"></i>Thống Kê Hiệu Suất</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0">
                    <div id="statsSummary" class="p-3 bg-light border-bottom"></div>
                    <div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead class="table-light"><tr><th>Tên Setup (Combo)</th><th class="text-center">Tổng</th><th class="text-center text-success">WIN</th><th class="text-center text-danger">LOSS</th><th class="text-center text-secondary">BE</th><th class="text-center">Winrate %</th></tr></thead><tbody id="statsTableBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPsMJJQDALXgBTuo4JcKe6TCSOLq9TVDWxNMGlnWirwOBAs_OjRDa2TD-TlmVz8YzKRw/exec"; 
        var historyDataCache = []; var currentDetailImages = []; var currentLightboxIndex = 0; var sortDirection = 0; var currentFilter = null;

        window.onload = () => { resetTime(); fetchOptions(); };

        function autoCalculateResult(input) {
            const pip = parseFloat(input.value); const select = document.getElementById('ketquaSelect');
            if (isNaN(pip)) return;
            let resultText = ""; if (pip > 10) resultText = "WIN"; else if (pip < 0) resultText = "LOSS"; else resultText = "BE"; 
            for (let i = 0; i < select.options.length; i++) { if (select.options[i].text.toUpperCase().includes(resultText)) { select.selectedIndex = i; break; } }
        }
        
        function openHistoryModal() { currentFilter = null; document.getElementById('btnBackToStats').style.display = 'none'; document.getElementById('historyModalTitle').innerText = 'Lịch Sử Giao Dịch'; new bootstrap.Modal(document.getElementById('historyModal')).show(); fetchHistory(); }
        function openStatsModal() { new bootstrap.Modal(document.getElementById('statsModal')).show(); if (historyDataCache.length === 0) { fetchHistory(true); } else { calculateAndShowStats(); } }
        function backToStats() { bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide(); new bootstrap.Modal(document.getElementById('statsModal')).show(); }

        // [QUAN TRỌNG] HÀM LỌC NÂNG CẤP (XỬ LÝ CẢ NULL SETUPNAME)
        function filterAndShowHistory(setupName, type) {
            currentFilter = { setupName, type };
            bootstrap.Modal.getInstance(document.getElementById('statsModal')).hide();
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            
            // Đặt tiêu đề cho đúng
            let displaySetup = setupName === null ? "TẤT CẢ (ALL)" : setupName;
            document.getElementById('historyModalTitle').innerText = `Chi tiết: ${displaySetup} - ${type}`;
            document.getElementById('btnBackToStats').style.display = 'inline-block';
            historyModal.show();

            const filteredData = historyDataCache.filter(item => {
                let sName = item.entry ? item.entry.trim() : "(Trống)"; if(sName === "") sName = "(Trống)";
                
                // NẾU SETUPNAME != NULL THÌ MỚI LỌC THEO SETUP, CÒN NULL THÌ LẤY HẾT
                if (setupName !== null && sName !== setupName) return false;

                // CHECK KẾT QUẢ
                let resultText = item.ketqua ? item.ketqua.toUpperCase() : ""; let pip = parseFloat(item.pip);
                let isWin = (!isNaN(pip) && pip > 10) || resultText.includes("WIN");
                let isLoss = (!isNaN(pip) && pip < 0) || resultText.includes("LOSS");
                let isBe = (!isNaN(pip) && pip >= 0 && pip <= 10) || resultText.includes("BE");

                if (type === 'TOTAL') return true;
                if (type === 'WIN' && isWin) return true;
                if (type === 'LOSS' && isLoss) return true;
                if (type === 'BE' && isBe) return true;
                return false;
            });
            renderHistoryTable(filteredData);
        }

        // [QUAN TRỌNG] HÀM TẠO DASHBOARD + BẢNG
        function calculateAndShowStats() {
            const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = "";
            const summaryDiv = document.getElementById('statsSummary');
            
            // 1. DASHBOARD
            let grandTotal = 0, grandWin = 0, grandLoss = 0, grandBe = 0;
            historyDataCache.forEach(item => {
                grandTotal++;
                let pip = parseFloat(item.pip); let resultText = item.ketqua ? item.ketqua.toUpperCase() : "";
                if ((!isNaN(pip) && pip > 10) || resultText.includes("WIN")) grandWin++;
                else if ((!isNaN(pip) && pip < 0) || resultText.includes("LOSS")) grandLoss++;
                else grandBe++;
            });
            let grandWinrate = grandTotal > 0 ? ((grandWin / grandTotal) * 100).toFixed(1) : 0;

            // RENDER DASHBOARD CÓ ONCLICK
            summaryDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-6 col-md-2 offset-md-1">
                        <div class="summary-box sb-total" onclick="filterAndShowHistory(null, 'TOTAL')" title="Xem toàn bộ lệnh"><h3>${grandTotal}</h3><span>Tổng Lệnh</span></div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="summary-box sb-win" onclick="filterAndShowHistory(null, 'WIN')" title="Xem lệnh Win"><h3>${grandWin}</h3><span>Win</span></div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="summary-box sb-loss" onclick="filterAndShowHistory(null, 'LOSS')" title="Xem lệnh Loss"><h3>${grandLoss}</h3><span>Loss</span></div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="summary-box sb-be" onclick="filterAndShowHistory(null, 'BE')" title="Xem lệnh BE"><h3>${grandBe}</h3><span>Hòa/BE</span></div>
                    </div>
                    <div class="col-12 col-md-2">
                        <div class="summary-box sb-rate"><h3>${grandWinrate}%</h3><span>Winrate</span></div>
                    </div>
                </div>
            `;

            // 2. BẢNG CHI TIẾT
            let stats = {};
            historyDataCache.forEach(item => {
                let setupName = item.entry ? item.entry.trim() : "(Trống)"; if (setupName === "") setupName = "(Trống)";
                let resultText = item.ketqua ? item.ketqua.toUpperCase() : ""; let pip = parseFloat(item.pip);
                let isWin = (!isNaN(pip) && pip > 10) || resultText.includes("WIN");
                let isLoss = (!isNaN(pip) && pip < 0) || resultText.includes("LOSS");
                let isBe = (!isNaN(pip) && pip >= 0 && pip <= 10) || resultText.includes("BE");
                if(!stats[setupName]) stats[setupName] = { win: 0, loss: 0, be: 0, total: 0 };
                if (isWin || isLoss || isBe) {
                    stats[setupName].total++;
                    if (isWin) stats[setupName].win++; else if (isLoss) stats[setupName].loss++; else if (isBe) stats[setupName].be++;
                }
            });

            let statsArray = Object.keys(stats).map(key => { return { name: key, ...stats[key] }; });
            statsArray.sort((a, b) => b.total - a.total);

            if(statsArray.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-3">Chưa có dữ liệu thống kê.</td></tr>'; return; }

            statsArray.forEach(s => {
                let winrate = s.total > 0 ? ((s.win / s.total) * 100).toFixed(1) : 0;
                let progressClass = winrate >= 50 ? "bg-success" : (winrate < 30 ? "bg-danger" : "bg-primary");
                const safeName = s.name.replace(/'/g, "\\'"); 
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold">${s.name}</td>
                    <td class="text-center fw-bold stat-clickable" onclick="filterAndShowHistory('${safeName}', 'TOTAL')">${s.total}</td>
                    <td class="text-center text-success stat-clickable" onclick="filterAndShowHistory('${safeName}', 'WIN')">${s.win}</td>
                    <td class="text-center text-danger stat-clickable" onclick="filterAndShowHistory('${safeName}', 'LOSS')">${s.loss}</td>
                    <td class="text-center text-secondary stat-clickable" onclick="filterAndShowHistory('${safeName}', 'BE')">${s.be}</td>
                    <td class="text-center" style="width: 150px;"><div class="stat-winrate ${winrate >= 50 ? 'text-success' : 'text-danger'}">${winrate}%</div><div class="progress"><div class="progress-bar ${progressClass}" role="progressbar" style="width: ${winrate}%"></div></div></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function fetchHistory(isShowStats = false) {
            const tbody = document.getElementById('historyTableBody'); if(!isShowStats) tbody.innerHTML = '<tr><td colspan="6" class="p-3 text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Đang tải...</td></tr>';
            fetch(WEB_APP_URL + "?mode=history").then(r => r.json()).then(data => { historyDataCache = data; if(isShowStats) { calculateAndShowStats(); } else { renderHistoryTable(data); } }).catch(e => console.error(e));
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = "";
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-3">Chưa có dữ liệu</td></tr>'; return; }
            data.forEach((item, index) => {
                let badgeClass = "bg-be"; let kq = item.ketqua || "---"; 
                let pip = parseFloat(item.pip);
                if (!isNaN(pip)) { if (pip > 10) { badgeClass = "bg-win"; kq = "WIN"; } else if (pip < 0) { badgeClass = "bg-loss"; kq = "LOSS"; } else { badgeClass = "bg-be"; kq = "BE"; } } 
                else { if(kq.toUpperCase().includes("WIN")) badgeClass = "bg-win"; else if(kq.toUpperCase().includes("LOSS")) badgeClass = "bg-loss"; }
                let pipVal = parseFloat(item.pip) || 0; let pipClass = pipVal > 0 ? 'text-success' : (pipVal < 0 ? 'text-danger' : '');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="fw-bold text-muted">#${item.id||(index+1)}</td><td>${item.time.replace("T", " ")}</td><td class="fw-bold text-primary">${item.trade}</td><td><span class="status-badge ${badgeClass}">${kq}</span></td><td class="fw-bold ${pipClass}">${item.pip}</td><td><button class="btn btn-sm btn-outline-primary" onclick="showDetail('${item.id}')"><i class="fas fa-eye"></i> Xem</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function sortHistoryByPip() {
            let dataToSort = currentFilter ? historyDataCache.filter(item => {
                let sName = item.entry ? item.entry.trim() : "(Trống)"; if(sName==="") sName="(Trống)";
                if (currentFilter.setupName !== null && sName !== currentFilter.setupName) return false;
                let resultText = item.ketqua ? item.ketqua.toUpperCase() : ""; let pip = parseFloat(item.pip);
                let isWin = (!isNaN(pip) && pip > 10) || resultText.includes("WIN");
                let isLoss = (!isNaN(pip) && pip < 0) || resultText.includes("LOSS");
                let isBe = (!isNaN(pip) && pip >= 0 && pip <= 10) || resultText.includes("BE");
                if (currentFilter.type === 'TOTAL') return true; if (currentFilter.type === 'WIN' && isWin) return true; if (currentFilter.type === 'LOSS' && isLoss) return true; if (currentFilter.type === 'BE' && isBe) return true; return false;
            }) : [...historyDataCache];

            if (dataToSort.length === 0) return;
            if (sortDirection === 0 || sortDirection === -1) sortDirection = 1; else sortDirection = -1;
            const icon = document.getElementById('sortIcon'); icon.className = 'fas sort-icon'; 
            if(sortDirection===1) icon.classList.add('fa-sort-amount-up', 'sort-active'); else if(sortDirection===-1) icon.classList.add('fa-sort-amount-down', 'sort-active'); else icon.classList.add('fa-sort');
            
            dataToSort.sort((a, b) => { let valA = parseFloat(a.pip) || 0; let valB = parseFloat(b.pip) || 0; return sortDirection * (valA - valB); });
            renderHistoryTable(dataToSort);
        }

        function showDetail(id) {
            const item = historyDataCache.find(x => x.id == id); if(!item) return;
            const detailModal = new bootstrap.Modal(document.getElementById('detailModal')); document.getElementById('detailTitle').innerText = `Chi tiết lệnh: ${item.trade} (${item.time})`;
            currentDetailImages = []; const imgSources = [{src: item.d1, title: 'D1 Chart'}, {src: item.h4, title: 'H4 Chart'}, {src: item.h1, title: 'H1 Chart'}, {src: item.m15, title: 'M15 Chart'}, {src: item.thucte, title: 'Kết quả Thực tế'}];
            imgSources.forEach(img => { if(img.src && img.src.includes('http')) currentDetailImages.push(img); });
            let imgsHtml = '<div class="row g-2 mt-3">';
            if (currentDetailImages.length > 0) { currentDetailImages.forEach((img, index) => { imgsHtml += `<div class="col-4 col-md-2"><div class="detail-img-box" onclick="openLightbox(${index})"><img src="${img.src}"><span>${img.title}</span></div></div>`; }); } else { imgsHtml += '<div class="col-12 text-muted fst-italic">Không có hình ảnh.</div>'; } imgsHtml += '</div>';
            const bodyHtml = `<div class="row g-3"><div class="col-md-4"><span class="detail-label">Entry Setup:</span> <div class="detail-value">${item.entry}</div></div><div class="col-md-4"><span class="detail-label">Phiên:</span> <div class="detail-value">${item.phien}</div></div><div class="col-md-4"><span class="detail-label">Gồng lệnh:</span> <div class="detail-value">${item.gong_lenh}</div></div><div class="col-md-4"><span class="detail-label">Kết quả:</span> <div class="detail-value fw-bold">${item.ketqua}</div></div><div class="col-md-4"><span class="detail-label">Số Pip:</span> <div class="detail-value fw-bold">${item.pip}</div></div><div class="col-12 bg-light p-2 rounded"><span class="detail-label">Ghi chú:</span> <div class="text-danger">${item.ghi_chu}</div></div><div class="col-md-6"><span class="detail-label">Cảm nhận:</span> <div class="fst-italic">${item.cam_nhan}</div></div><div class="col-md-6"><span class="detail-label">Góc nhìn HTF/LTF:</span> <div class="fst-italic">${item.goc_nhin}</div></div></div><h6 class="mt-4 text-primary border-bottom pb-2">Hình ảnh phân tích (Bấm để xem Gallery)</h6>${imgsHtml}`;
            document.getElementById('detailBody').innerHTML = bodyHtml; bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide(); detailModal.show();
        }

        function openLightbox(index) { if (currentDetailImages.length === 0) return; currentLightboxIndex = index; updateLightboxContent(); document.getElementById('lightbox-gallery').style.display = 'flex'; }
        function openSingleImage(imgEl) { if (imgEl.src && imgEl.src.includes('http')) { currentDetailImages = [{src: imgEl.src, title: 'Xem trước'}]; openLightbox(0); } }
        function closeLightbox() { document.getElementById('lightbox-gallery').style.display = 'none'; }
        function changeImage(step) { currentLightboxIndex += step; if (currentLightboxIndex >= currentDetailImages.length) currentLightboxIndex = 0; if (currentLightboxIndex < 0) currentLightboxIndex = currentDetailImages.length - 1; updateLightboxContent(); }
        function updateLightboxContent() { const imgObj = currentDetailImages[currentLightboxIndex]; document.getElementById('lightbox-img').src = imgObj.src; document.getElementById('lightbox-caption').innerText = `${imgObj.title} (${currentLightboxIndex + 1}/${currentDetailImages.length})`; }
        document.addEventListener('keydown', function(e) { if (document.getElementById('lightbox-gallery').style.display === 'flex') { if (e.key === "ArrowLeft") changeImage(-1); if (e.key === "ArrowRight") changeImage(1); if (e.key === "Escape") closeLightbox(); } });
        
        function resetTime() { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('thoigian').value = now.toISOString().slice(0,16); }
        function fetchOptions() { fetch(WEB_APP_URL + "?mode=options").then(r => r.json()).then(data => { populateDatalist("entryList", data.entry); populateSelect("ketquaSelect", data.ketqua); if(data.dongtien) populateSelect("tradeSelect", data.dongtien); document.getElementById('status-connect').style.display='none'; }); }
        function populateDatalist(id, data) { const list = document.getElementById(id); if(list) { list.innerHTML = ""; data.forEach(i => { const o = document.createElement('option'); o.value = i; list.appendChild(o); }); } }
        function populateSelect(id, data) { const s = document.getElementById(id); if(s) { s.innerHTML = '<option value="">-- Chọn --</option>'; data.forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; s.appendChild(o); }); } }
        function addEntryField() { const c = document.getElementById('entry-container'); const d = document.createElement('div'); d.className = 'input-group mb-2 entry-row'; d.innerHTML = `<input type="text" class="form-control entry-input" list="entryList" placeholder="Thêm..."><button class="btn btn-outline-danger" onclick="removeEntryField(this)"><i class="fas fa-minus"></i></button>`; c.appendChild(d); }
        function removeEntryField(b) { b.parentElement.remove(); }
        function preview(i) { const m = i.nextElementSibling; if(i.value && i.value.includes('http')) { m.src = i.value; m.style.display = 'block'; } else { m.style.display = 'none'; } }
        function submitToSheet(e) { e.preventDefault(); const form = document.getElementById('webForm'); const loading = document.getElementById('loadingOverlay'); const formData = new FormData(form); const data = {}; formData.forEach((v, k) => data[k] = v); const entries = []; document.querySelectorAll('.entry-input').forEach(i => { if(i.value.trim()) entries.push(i.value.trim()); }); data.entry = entries.join(", "); if(data.thoigian) data.thoigian = data.thoigian.replace("T", " "); loading.style.display = 'flex'; fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(data) }).then(() => { loading.style.display = 'none'; Swal.fire({ icon: 'success', title: 'Đã lưu!', timer: 1500, showConfirmButton: false }); form.reset(); resetTime(); document.querySelectorAll('.img-preview').forEach(e => e.style.display = 'none'); document.getElementById('entry-container').innerHTML = `<div class="input-group mb-2 entry-row"><input type="text" class="form-control entry-input" list="entryList" placeholder="Nhập setup..."><button class="btn btn-outline-success" type="button" onclick="addEntryField()"><i class="fas fa-plus"></i></button></div>`; }).catch(e => { loading.style.display = 'none'; Swal.fire('Lỗi', 'Không gửi được', 'error'); }); }
    </script>
</body>
</html>
