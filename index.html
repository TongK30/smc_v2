<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - HTF Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .main-card { max-width: 1000px; margin: 30px auto; border: none; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-header { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 12px 12px 0 0 !important; padding: 15px 20px; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #555; }
        .btn-submit { padding: 12px 50px; font-weight: bold; text-transform: uppercase; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }

        /* --- 1. CSS CHO LIGHTBOX GALLERY (MỚI) --- */
        #lightbox-gallery {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000;
            display: none; /* Mặc định ẩn */
            flex-direction: column; justify-content: center; align-items: center;
        }
        #lightbox-img { max-width: 90%; max-height: 80vh; border: 2px solid white; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        #lightbox-caption { color: white; margin-top: 10px; font-size: 1.2rem; font-weight: bold; }
        
        .lightbox-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); color: white;
            border: none; padding: 15px; cursor: pointer; font-size: 2rem;
            border-radius: 50%; transition: 0.3s;
        }
        .lightbox-nav:hover { background: rgba(255,255,255,0.3); }
        .lb-prev { left: 20px; }
        .lb-next { right: 20px; }
        .lb-close { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; color: white; cursor: pointer; }
        
        /* ẢNH THUMBNAIL */
        .img-preview { width: 100%; height: 120px; object-fit: cover; border: 1px dashed #ccc; border-radius: 6px; margin-top: 5px; display: none; background-color: #fff; cursor: zoom-in; }

        /* --- 2. CSS CHO BẢNG & SORT (MỚI) --- */
        .table-history th { background-color: #f1f3f5; font-size: 0.85rem; text-transform: uppercase; text-align: center; vertical-align: middle; }
        .table-history td { vertical-align: middle; font-size: 0.9rem; text-align: center; }
        
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #e9ecef; }
        .sort-icon { margin-left: 5px; color: #999; font-size: 0.8rem; }
        .sort-active { color: #0d6efd; font-weight: bold; }

        .status-badge { padding: 4px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; }
        .bg-win { background-color: #d1e7dd; color: #0f5132; }
        .bg-loss { background-color: #f8d7da; color: #842029; }
        .bg-be { background-color: #e2e3e5; color: #41464b; }
        
        .detail-img-box { width: 100%; height: 150px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative; cursor: zoom-in; transition: transform 0.2s; }
        .detail-img-box:hover { transform: scale(1.03); border-color: #0d6efd; }
        .detail-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .detail-img-box span { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; text-align: center; font-size: 0.8rem; padding: 3px; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div><h5 class="text-primary fw-bold">Đang xử lý dữ liệu...</h5></div>

    <div id="lightbox-gallery">
        <div class="lb-close" onclick="closeLightbox()">&times;</div>
        <button class="lightbox-nav lb-prev" onclick="changeImage(-1)">&#10094;</button>
        <img id="lightbox-img" src="" alt="Full Image">
        <div id="lightbox-caption">Caption</div>
        <button class="lightbox-nav lb-next" onclick="changeImage(1)">&#10095;</button>
    </div>

    <div class="container pb-5">
        <div class="card main-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="m-0"><i class="fas fa-chart-line me-2"></i>NHẬP LỆNH (HTF)</h5>
                <div>
                    <small id="status-connect" class="badge bg-warning text-dark me-2"><i class="fas fa-sync fa-spin me-1"></i> Connecting...</small>
                    <button class="btn btn-sm btn-light text-primary fw-bold" onclick="openHistoryModal()"><i class="fas fa-history me-1"></i> Lịch sử</button>
                </div>
            </div>

            <div class="card-body p-4">
                <form id="webForm" onsubmit="submitToSheet(event)">
                    <div class="row g-3 mb-3">
                        <div class="col-md-3"><label class="form-label">Thời gian</label><input type="datetime-local" class="form-control" name="thoigian" id="thoigian" required></div>
                        <div class="col-md-3"><label class="form-label">Cặp Tiền (Dòng tiền)</label><select class="form-select" name="trade" id="tradeSelect" required><option value="">Loading...</option></select></div>
                        <div class="col-md-3"><label class="form-label">Phiên</label><select class="form-select" name="phien"><option value="Phiên Á">Phiên Á</option><option value="Phiên Âu">Phiên Âu</option><option value="Phiên Mỹ">Phiên Mỹ</option><option value="Giao thoa">Giao thoa</option></select></div>
                        <div class="col-md-3"><label class="form-label">Setup (Entry)</label><div id="entry-container"><div class="input-group mb-2 entry-row"><input type="text" class="form-control entry-input" list="entryList" placeholder="Nhập setup..."><button class="btn btn-outline-success" type="button" onclick="addEntryField()"><i class="fas fa-plus"></i></button></div></div><datalist id="entryList"></datalist></div>
                    </div>
                    <hr class="text-muted opacity-25">
                    <h6 class="text-primary mb-3"><i class="fas fa-images me-2"></i>Hình ảnh phân tích</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="d1" placeholder="Link ảnh D1..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="h4" placeholder="Link ảnh H4..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="h1" placeholder="Link ảnh H1..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                        <div class="col-md-3"><input type="url" class="form-control form-control-sm mb-1" name="m15" placeholder="Link ảnh M15..." oninput="preview(this)"><img class="img-preview" onclick="openSingleImage(this)"></div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label">Cảm nhận & Góc nhìn</label><textarea class="form-control mb-2" name="cam_nhan" rows="2"></textarea><textarea class="form-control" name="CainhinHTFvsLTF" rows="2"></textarea></div>
                        <div class="col-md-6"><div class="row g-2"><div class="col-md-6"><label class="form-label">Kết quả</label><select class="form-select" name="ketqua" id="ketquaSelect"><option value="">Loading...</option></select></div><div class="col-md-6"><label class="form-label">Số Pip</label><input type="number" step="0.1" class="form-control" name="pip"></div><div class="col-md-12"><label class="form-label">Gồng lệnh</label><input type="text" class="form-control" name="gong_lenh"></div></div></div>
                    </div>
                     <div class="mb-4"><label class="form-label">Ảnh Thực tế & Ghi chú</label><div class="row g-2"><div class="col-md-6"><input type="url" class="form-control" name="thucte" placeholder="Link ảnh thực tế..." oninput="preview(this)"><img class="img-preview" style="height: 80px;" onclick="openSingleImage(this)"></div><div class="col-md-6"><textarea class="form-control" name="ghi_chu" rows="1" placeholder="Ghi chú thêm..."></textarea></div></div></div>
                    <div class="text-center"><button type="submit" class="btn btn-primary btn-submit shadow"><i class="fas fa-paper-plane me-2"></i> LƯU NHẬT KÝ</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Lịch Sử Giao Dịch</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-history mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>STT</th>
                                    <th>Thời gian</th>
                                    <th>Cặp tiền</th>
                                    <th>Kết quả</th>
                                    <th class="sortable-header" onclick="sortHistoryByPip()" title="Sắp xếp theo Pip">
                                        Pip <i id="sortIcon" class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Chi tiết</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="detailTitle">Chi tiết lệnh</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailBody">
                    </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-target="#historyModal" data-bs-toggle="modal">Quay lại</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ==============================================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbytj4e1BVh1my6K4th1a-KUKvbZWZT2-0mhIeTYndefvKhNnRR_3aDjjzvohvxWmFnXnA/exec"; 
        // ==============================================================

        var historyDataCache = []; // Lưu trữ dữ liệu gốc
        var currentDetailImages = []; // Lưu danh sách ảnh của lệnh đang xem
        var currentLightboxIndex = 0; // Vị trí ảnh đang xem
        var sortDirection = 0; // 0: Mặc định, 1: Tăng dần, -1: Giảm dần

        window.onload = () => { resetTime(); fetchOptions(); };
        
        function openHistoryModal() {
            var myModal = new bootstrap.Modal(document.getElementById('historyModal'));
            myModal.show();
            fetchHistory();
        }

        // --- 1. HÀM TẢI & RENDER LỊCH SỬ ---
        function fetchHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-3"><div class="spinner-border spinner-border-sm text-primary"></div> Đang tải...</td></tr>';
            
            fetch(WEB_APP_URL + "?mode=history")
                .then(r => r.json())
                .then(data => {
                    historyDataCache = data;
                    sortDirection = 0; // Reset sort
                    updateSortIcon();
                    renderHistoryTable(historyDataCache);
                })
                .catch(e => tbody.innerHTML = '<tr><td colspan="6" class="text-danger">Lỗi kết nối</td></tr>');
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = "";
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-3">Chưa có dữ liệu</td></tr>'; return;
            }

            data.forEach((item, index) => {
                let badgeClass = "bg-be";
                let kq = item.ketqua || "---";
                if(kq.toUpperCase().includes("WIN")) badgeClass = "bg-win";
                else if(kq.toUpperCase().includes("LOSS")) badgeClass = "bg-loss";

                // Chỉ số Pip (Màu xanh/đỏ)
                let pipVal = parseFloat(item.pip) || 0;
                let pipClass = pipVal > 0 ? 'text-success' : (pipVal < 0 ? 'text-danger' : '');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-muted">#${item.id || (index+1)}</td>
                    <td>${item.time.replace("T", " ")}</td>
                    <td class="fw-bold text-primary">${item.trade}</td>
                    <td><span class="status-badge ${badgeClass}">${kq}</span></td>
                    <td class="fw-bold ${pipClass}">${item.pip}</td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="showDetail('${item.id}')"><i class="fas fa-eye"></i> Xem</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 2. HÀM SẮP XẾP PIP (SORTING) ---
        function sortHistoryByPip() {
            if(historyDataCache.length === 0) return;

            // Đảo chiều sắp xếp: 0 -> 1 (Tăng) -> -1 (Giảm) -> 1 ...
            if (sortDirection === 0 || sortDirection === -1) sortDirection = 1;
            else sortDirection = -1;

            updateSortIcon();

            // Clone mảng để sort
            let sortedData = [...historyDataCache];
            sortedData.sort((a, b) => {
                let valA = parseFloat(a.pip) || 0;
                let valB = parseFloat(b.pip) || 0;
                return sortDirection * (valA - valB); // 1: Tăng, -1: Giảm
            });

            renderHistoryTable(sortedData);
        }

        function updateSortIcon() {
            const icon = document.getElementById('sortIcon');
            icon.className = 'fas sort-icon'; // Reset class
            if(sortDirection === 1) {
                icon.classList.add('fa-sort-amount-up', 'sort-active');
            } else if(sortDirection === -1) {
                icon.classList.add('fa-sort-amount-down', 'sort-active');
            } else {
                icon.classList.add('fa-sort');
            }
        }

        // --- 3. HÀM CHI TIẾT & CHUẨN BỊ ẢNH CHO GALLERY ---
        function showDetail(id) {
            // Tìm item theo ID (vì sau khi sort index sẽ thay đổi)
            const item = historyDataCache.find(x => x.id == id);
            if(!item) return;

            const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            document.getElementById('detailTitle').innerText = `Chi tiết lệnh: ${item.trade} (${item.time})`;
            
            // TẠO DANH SÁCH ẢNH CHO GALLERY
            currentDetailImages = []; // Reset list ảnh
            const imgSources = [
                {src: item.d1, title: 'D1 Chart'}, {src: item.h4, title: 'H4 Chart'},
                {src: item.h1, title: 'H1 Chart'}, {src: item.m15, title: 'M15 Chart'},
                {src: item.thucte, title: 'Kết quả Thực tế'}
            ];
            
            // Chỉ lấy ảnh có link hợp lệ
            imgSources.forEach(img => {
                if(img.src && img.src.includes('http')) {
                    currentDetailImages.push(img);
                }
            });

            // Tạo HTML hiển thị Thumbnail
            let imgsHtml = '<div class="row g-2 mt-3">';
            if (currentDetailImages.length > 0) {
                currentDetailImages.forEach((img, index) => {
                    imgsHtml += `
                        <div class="col-4 col-md-2">
                            <div class="detail-img-box" onclick="openLightbox(${index})">
                                <img src="${img.src}">
                                <span>${img.title}</span>
                            </div>
                        </div>`;
                });
            } else {
                imgsHtml += '<div class="col-12 text-muted fst-italic">Không có hình ảnh.</div>';
            }
            imgsHtml += '</div>';

            const bodyHtml = `
                <div class="row g-3">
                    <div class="col-md-4"><span class="detail-label">Entry Setup:</span> <div class="detail-value">${item.entry}</div></div>
                    <div class="col-md-4"><span class="detail-label">Phiên:</span> <div class="detail-value">${item.phien}</div></div>
                    <div class="col-md-4"><span class="detail-label">Gồng lệnh:</span> <div class="detail-value">${item.gong_lenh}</div></div>
                    
                    <div class="col-md-4"><span class="detail-label">Kết quả:</span> <div class="detail-value fw-bold">${item.ketqua}</div></div>
                    <div class="col-md-4"><span class="detail-label">Số Pip:</span> <div class="detail-value fw-bold">${item.pip}</div></div>
                    
                    <div class="col-12 bg-light p-2 rounded">
                        <span class="detail-label">Ghi chú:</span> <div class="text-danger">${item.ghi_chu}</div>
                    </div>
                    
                    <div class="col-md-6"><span class="detail-label">Cảm nhận:</span> <div class="fst-italic">${item.cam_nhan}</div></div>
                    <div class="col-md-6"><span class="detail-label">Góc nhìn HTF/LTF:</span> <div class="fst-italic">${item.goc_nhin}</div></div>
                </div>
                
                <h6 class="mt-4 text-primary border-bottom pb-2">Hình ảnh phân tích (Bấm để xem Gallery)</h6>
                ${imgsHtml}
            `;
            
            document.getElementById('detailBody').innerHTML = bodyHtml;
            bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
            detailModal.show();
        }

        // --- 4. HÀM LIGHTBOX GALLERY (CHUYỂN ẢNH) ---
        function openLightbox(index) {
            if (currentDetailImages.length === 0) return;
            currentLightboxIndex = index;
            updateLightboxContent();
            document.getElementById('lightbox-gallery').style.display = 'flex';
        }

        // Mở ảnh đơn ở màn hình nhập liệu
        function openSingleImage(imgEl) {
             if (imgEl.src && imgEl.src.includes('http')) {
                 currentDetailImages = [{src: imgEl.src, title: 'Xem trước'}];
                 openLightbox(0);
             }
        }

        function closeLightbox() {
            document.getElementById('lightbox-gallery').style.display = 'none';
        }

        function changeImage(step) {
            currentLightboxIndex += step;
            // Loop vòng tròn: Cuối -> Đầu và ngược lại
            if (currentLightboxIndex >= currentDetailImages.length) currentLightboxIndex = 0;
            if (currentLightboxIndex < 0) currentLightboxIndex = currentDetailImages.length - 1;
            updateLightboxContent();
        }

        function updateLightboxContent() {
            const imgObj = currentDetailImages[currentLightboxIndex];
            document.getElementById('lightbox-img').src = imgObj.src;
            document.getElementById('lightbox-caption').innerText = `${imgObj.title} (${currentLightboxIndex + 1}/${currentDetailImages.length})`;
        }

        // Hỗ trợ phím mũi tên
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightbox-gallery').style.display === 'flex') {
                if (e.key === "ArrowLeft") changeImage(-1);
                if (e.key === "ArrowRight") changeImage(1);
                if (e.key === "Escape") closeLightbox();
            }
        });

        // --- CÁC HÀM CƠ BẢN GIỮ NGUYÊN ---
        function resetTime() { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('thoigian').value = now.toISOString().slice(0,16); }
        function fetchOptions() { fetch(WEB_APP_URL + "?mode=options").then(r => r.json()).then(data => { populateDatalist("entryList", data.entry); populateSelect("ketquaSelect", data.ketqua); if(data.dongtien) populateSelect("tradeSelect", data.dongtien); document.getElementById('status-connect').style.display='none'; }); }
        function populateDatalist(id, data) { const list = document.getElementById(id); if(list) { list.innerHTML = ""; data.forEach(i => { const o = document.createElement('option'); o.value = i; list.appendChild(o); }); } }
        function populateSelect(id, data) { const s = document.getElementById(id); if(s) { s.innerHTML = '<option value="">-- Chọn --</option>'; data.forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; s.appendChild(o); }); } }
        function addEntryField() { const c = document.getElementById('entry-container'); const d = document.createElement('div'); d.className = 'input-group mb-2 entry-row'; d.innerHTML = `<input type="text" class="form-control entry-input" list="entryList" placeholder="Thêm..."><button class="btn btn-outline-danger" onclick="removeEntryField(this)"><i class="fas fa-minus"></i></button>`; c.appendChild(d); }
        function removeEntryField(b) { b.parentElement.remove(); }
        function preview(i) { const m = i.nextElementSibling; if(i.value && i.value.includes('http')) { m.src = i.value; m.style.display = 'block'; } else { m.style.display = 'none'; } }
        function submitToSheet(e) { e.preventDefault(); const form = document.getElementById('webForm'); const loading = document.getElementById('loadingOverlay'); const formData = new FormData(form); const data = {}; formData.forEach((v, k) => data[k] = v); const entries = []; document.querySelectorAll('.entry-input').forEach(i => { if(i.value.trim()) entries.push(i.value.trim()); }); data.entry = entries.join(", "); if(data.thoigian) data.thoigian = data.thoigian.replace("T", " "); loading.style.display = 'flex'; fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(data) }).then(() => { loading.style.display = 'none'; Swal.fire({ icon: 'success', title: 'Đã lưu!', timer: 1500, showConfirmButton: false }); form.reset(); resetTime(); document.querySelectorAll('.img-preview').forEach(e => e.style.display = 'none'); document.getElementById('entry-container').innerHTML = `<div class="input-group mb-2 entry-row"><input type="text" class="form-control entry-input" list="entryList" placeholder="Nhập setup..."><button class="btn btn-outline-success" type="button" onclick="addEntryField()"><i class="fas fa-plus"></i></button></div>`; }).catch(e => { loading.style.display = 'none'; Swal.fire('Lỗi', 'Không gửi được', 'error'); }); }
    </script>
</body>
</html>